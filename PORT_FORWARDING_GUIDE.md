# 端口转发说明文档

## 为什么需要端口转发？

### 网络架构问题
1. **Python服务器**运行在电脑上，监听 `9000` 端口
2. **Android应用**运行在手机上，尝试连接 `localhost:9001`
3. **问题**：手机的 `localhost` 指向手机自己，不是电脑

### 解决方案：ADB反向端口转发
使用 `adb reverse` 命令建立隧道：
- 手机连接 `localhost:9001` → 自动转发到 → 电脑的 `9000` 端口

## 为什么是手机9001，服务器9000？

### 端口分配逻辑
- **9000端口**：Python服务器监听端口（电脑端）
- **9001端口**：Android应用连接端口（手机端）
- **转发关系**：9001 → 9000

### 设计原因
1. **避免冲突**：分离客户端和服务器端口
2. **清晰区分**：9001=客户端，9000=服务器
3. **灵活配置**：可以轻松修改转发规则

## 自动化改进

### 之前的手动方式
```bash
adb reverse tcp:9001 tcp:9000
```
每次启动应用都需要手动执行这个命令。

### 现在的自动方式
Python服务器启动时自动执行：
1. 检测USB连接的Android设备
2. 自动清理旧的端口转发
3. 自动设置新的反向端口转发
4. 程序结束时自动清理

### 使用流程
1. 启动Python服务器 → **自动设置端口转发**
2. 启动Android应用 → **直接连接，无需手动命令**
3. 开始视频传输

## 连接模式

### USB模式（推荐）
- ✅ 自动端口转发
- ✅ 稳定连接
- ✅ 低延迟
- 要求：USB数据线 + USB调试

### WiFi模式（备选）
- ⚠️ 需要手动输入IP地址
- ⚠️ 网络延迟较高
- ✅ 无需数据线
- 要求：同一WiFi网络

## 故障排除

### 端口转发失败
1. 检查USB连接
2. 确认USB调试已启用
3. 授权电脑进行USB调试
4. 重启ADB服务：`adb kill-server && adb start-server`

### 连接被拒绝
1. 确认Python服务器正在运行
2. 检查防火墙设置
3. 验证端口转发状态：`adb reverse --list`

### 应用闪退
1. 查看Android日志：`adb logcat -s VideoStreamer`
2. 检查网络安全策略配置
3. 确认ImageProxy资源管理正确